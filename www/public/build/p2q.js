import{s as U}from"./assets/flashmessage-C-RgOmzp.js";const q=window.location.pathname.split("/")[2],O=window.location.pathname.split("/")[2],D=window.location.pathname.split("/")[1],E=$("#project_content"),z=document.getElementById("project_content"),N=$("#quote-content");let X,R;const K={adminProject:()=>{$("#admin-project-table").DataTable({ajax:{url:"/index/admin/project?view=true",dataSrc:""},processing:!0,responsive:!0,columns:[{data:"project_id_ext",render:function(e,t,a,d){return"<a target='_blank' href='/project/"+a.project_id+"/edit'>"+e+"</a>"}},{data:"project_name"},{data:"owner_id"},{data:"shared_id"},{data:"create_date.date",render:function(e){return new Date(e).toLocaleDateString()}},{data:"due_date.date",render:function(e){let t=new Date(e);return t<=new Date?'<span class="red">'+t.toLocaleDateString()+"</span>":t.toLocaleDateString()}},{data:"architect_name"},{data:"market_segment_desc"},{data:"status_desc"},{data:"project_id",render:function(e,t,a,d){return'<a target="_blank" href="/project/'+e+'/edit?open=make-quote"><span class="button-wrap"><span class="icon icon-money"></span></span></a>'}}],columnDefs:[{targets:"_all",className:"dt-head-center"},{targets:[0,2,3,4,5,7,8],className:"dt-body-center"}],order:[[0,"desc"]],fixedColumns:{start:1,end:1},scrollX:!0,layout:{topStart:function(){let e=document.createElement("div");return e.innerHTML="<h2>All projects</h2>",e},bottomStart:"pageLength"}})},adminQuote:()=>{$("#admin-quote-table").DataTable({ajax:{url:"/index/admin/quote?view=true",dataSrc:""},processing:!0,responsive:!0,columns:[{data:"quote_id",render:function(e,t,a,d){return"<a target='_blank' href='/quote/"+e+"/edit'>"+e+"</a>"}},{data:"project_name"},{data:"market_segment_desc"},{data:"quote_date.date",render:function(e){return new Date(e).toLocaleDateString()}},{data:"expire_date.date",render:function(e){let t=new Date(e);return t<=new Date?'<span class="red">'+t.toLocaleDateString()+"</span>":t.toLocaleDateString()}},{data:"ship_required_date.date",render:function(e){return e?"<p>"+new Date(e).toLocaleDateString("en-CA")+"</p>":"<p>--</p>"}},{data:"project_status"},{data:"quote_status_id",render:function(e){return e==4?'<span class="disapproved red">Disapproved</span>':e==3?'<span class="approved green">Approved</span>':e==2?'<span class="waiting orange">Waiting</span>':"Not submitted"}}],columnDefs:[{targets:"_all",className:"dt-head-center"},{targets:[0,2,3,4,5,6,7],className:"dt-body-center"}],order:[[0,"desc"]],fixedColumns:{start:1,end:1},scrollX:!0,layout:{topStart:function(){let e=document.createElement("div");return e.innerHTML="<h2>All quotes</h2>",e},bottomStart:"pageLength"}})},homeOwnProject:()=>{$("#dashboard-home-own-table").DataTable({ajax:{url:"/index/home/own?view=true",dataSrc:""},processing:!0,responsive:!0,columns:[{data:"project_id_ext",render:function(e,t,a,d){return"<a target='_blank' href='/project/"+a.project_id+"/edit' title='Edit project "+a.project_id+"'>"+e+"</a>"}},{data:"project_name"},{data:"shared_id"},{data:"market_segment_desc"},{data:"specifier_name"},{data:"create_date.date",render:function(e){return new Date(e).toLocaleDateString()}},{data:"due_date.date",render:function(e){let t=new Date(e);return t<=new Date?'<span class="red">'+t.toLocaleDateString()+"</span>":t.toLocaleDateString()}},{data:"status_desc"},{data:"project_id",render:function(e,t,a,d){return"<a target='_blank' href='/project/"+e+"/edit?open=make-quote'><span class='button-wrap'><span class='icon icon-money'></span></span></a>"}}],columnDefs:[{targets:"_all",className:"dt-head-center"},{targets:[0,2,3,5,6,7],className:"dt-body-center"}],order:{name:"project_id",dir:"desc"},fixedColumns:{start:1,end:2},scrollX:!0,layout:{topStart:function(){let e=document.createElement("div");return e.innerHTML="<h2>My Projects</h2><p>"+ownTableCount+" projects",e},bottomStart:"pageLength"}})},homeSharedProject:()=>{$("#dashboard-home-assigned-table").DataTable({ajax:{url:"/index/home/assigned",dataSrc:""},responsive:!0,columns:[{data:"project_id_ext",render:function(e,t,a,d){return"<a target='_blank' href='/project/"+a.project_id+"/edit'>"+e+"</a>"}},{data:"project_name"},{data:"owner_id"},{data:"market_segment_desc"},{data:"specifier_name"},{data:"create_date.date",render:function(e){return new Date(e).toLocaleDateString()}},{data:"due_date.date",render:function(e){let t=new Date(e);return t<=new Date?'<span class="red">'+t.toLocaleDateString()+"</span>":t.toLocaleDateString()}},{data:"status_desc"},{data:"project_id",render:function(e,t,a,d){return"<a target='_blank' href='/project/"+e+"/edit?open=make-quote'><span class='button-wrap'><span class='icon icon-money'></span></span></a>"}}],columnDefs:[{targets:"_all",className:"dt-head-center"},{targets:[0,2,3,5,6,7],className:"dt-body-center"}],processing:!0,order:{name:"project_id",dir:"desc"},fixedColumns:{start:1,end:2},scrollX:!0,layout:{topStart:function(){let e=document.createElement("div");return e.innerHTML="<h2>Shared Projects</h2>"+assignTableCount+" shared projects",e},bottomStart:"pageLength"}})},homeOtherProject:()=>{$("#dashboard-home-other-table").DataTable({ajax:{url:"/index/home/other",dataSrc:""},responsive:!0,columns:[{data:"project_id_ext",render:function(e,t,a,d){return"<a target='_blank' href='/project/"+a.project_id+"/edit'>"+e+"</a>"}},{data:"project_name"},{data:"owner_id"},{data:"shared_id"},{data:"market_segment_desc"},{data:"specifier_name"},{data:"create_date.date",render:function(e){return new Date(e).toLocaleDateString()}},{data:"due_date.date",render:function(e){let t=new Date(e);return t<=new Date?'<span class="red">'+t.toLocaleDateString()+"</span>":t.toLocaleDateString()}},{data:"project_id",render:function(e,t,a,d){return"<a target='_blank' href='/project/"+e+"/edit?open=make-quote'><span class='button-wrap'><span class='icon icon-money'></span></span></a>"}}],columnDefs:[{targets:"_all",className:"dt-head-center"},{targets:[0,2,3,4,6,7],className:"dt-body-center"}],processing:!0,order:{name:"project_id",dir:"desc"},fixedColumns:{start:1,end:1},scrollX:!0,layout:{topStart:function(){let e=document.createElement("div");return e.innerHTML="<h2>Other Projects At <?= $company ?></h2><p>"+otherTableCount+" projects at <?= $company ?>",e},bottomStart:"pageLength"}})},homeQuote:()=>{$("#dashboard-home-quote-table").DataTable({ajax:{url:"/index/home/quote",dataSrc:""},processing:!0,responsive:!0,columns:[{data:"quote_id",render:function(e,t,a,d){return"<a target='_blank' href='/quote/"+e+"/edit'>"+e+"</a>"}},{data:"project_id",render:function(e,t,a,d){return"<a target='_blank' href='/project/"+e+"/edit'>"+e+"</a>"}},{data:"project_name"},{data:"quote_date.date",render:function(e){return new Date(e).toLocaleDateString()}},{data:"expire_date.date",render:function(e){let t=new Date(e);return t<=new Date?'<span class="red">'+t.toLocaleDateString()+"</span>":t.toLocaleDateString()}},{data:"ship_required_date.date",render:function(e){return e?"<p>"+new Date(e).toLocaleDateString("en-CA")+"</p>":"<p>--</p>"}},{data:"customer_name"},{data:"project_status"},{data:"quote_status_id",render:function(e){return e==4?'<span class="disapproved red">Disapproved</span>':e==3?'<span class="approved green">Approved</span>':e==2?'<span class="waiting orange">Waiting</span>':"Not submitted"}}],columnDefs:[{targets:"_all",className:"dt-head-center"},{targets:[0,1,3,4,5,7,8],className:"dt-body-center"}],order:[[0,"desc"]],fixedColumns:{start:2,end:2},scrollX:!0,layout:{topStart:function(){let e=document.createElement("div");return e.innerHTML="<h2>My Quotes</h2>"+quoteTableCount+" quotes",e},bottomStart:"pageLength"}})},homeNote:()=>{$("#dashboard-home-note-table").DataTable({ajax:{url:"/index/home/note",dataSrc:""},processing:!0,responsive:!0,columns:[{data:"date_added.date",render:function(e){return"<p><b>"+new Date(e).toLocaleDateString("en-CA")+"</b></p>"}},{data:"project_id",render:function(e,t,a,d){return"<a target='_blank' href='/project/"+a.project_id+"/edit'>"+a.project_id+"</a>"}},{data:"project_name"},{data:"next_action",render:function(e){return"<p>"+e.replace(/(?:\r\n|\r|\n)/g,"<br>")+"</p>"}}],columnDefs:[{targets:[0,1,2,3],className:"dt-head-center"},{targets:[0,1],className:"dt-body-center"}],fixedColumns:{},scrollX:!0,order:[[0,"desc"]],layout:{topStart:function(){let e=document.createElement("div");return e.innerHTML="<h2>Follow Up Notes</h2>"+noteTableCount+" notes",e},bottomStart:"pageLength"}})},approvalWaiting:()=>{$("#dashboard-approve-waiting-table").DataTable({ajax:{url:"/index/approval/waiting",dataSrc:""},processing:!0,responsive:!0,columns:[{data:"quote_id",render:function(e,t,a,d){return"<a target='_blank' href='/quote/"+e+"/edit'>"+e+"</a>"}},{data:"project_name"},{data:"architect_rep_id"},{data:"customer_name"},{data:"owner_name"},{data:"market_segment_desc"},{data:"quote_date.date",render:function(e){return new Date(e).toLocaleDateString()}},{data:"ship_required_date.date",render:function(e){return new Date(e).toLocaleDateString()}},{data:"quote_status"}],columnDefs:[{targets:"_all",className:"dt-head-center"},{targets:[0,2,3,4,5,6,7,8],className:"dt-body-center"}],order:[[0,"desc"]],fixedColumns:{start:1,end:1},scrollX:!0,layout:{topStart:function(){let e=document.createElement("div");return e.innerHTML="<h2>Waiting for Approval</h2><p>"+waitingTableCount+" quotes waiting for approval</p>",e},bottomStart:"pageLength"}})},approvalApproved:()=>{$("#dashboard-approve-approved-table").DataTable({ajax:{url:"/index/approval/approved",dataSrc:""},responsive:!0,processing:!0,columns:[{data:"quote_id",render:function(e,t,a,d){return"<a target='_blank' href='/quote/"+e+"/edit'>"+e+"</a>"}},{data:"project_name"},{data:"architect_name"},{data:"customer_name"},{data:"owner_name"},{data:"market_segment_desc"},{data:"quote_date.date",render:function(e){return new Date(e).toLocaleDateString()}},{data:"expire_date.date",render:function(e){let t=new Date(e);return t<=new Date?'<span class="red">'+t.toLocaleDateString()+"</span>":t.toLocaleDateString()}},{data:"ship_required_date.date",render:function(e){return new Date(e).toLocaleDateString()}},{data:"quote_status"},{data:"order_no"}],columnDefs:[{targets:"_all",className:"dt-head-center"},{targets:[0,4,5,6,7,8,9,10],className:"dt-body-center"}],order:[[0,"desc"]],fixedColumns:{start:1,end:1},scrollX:!0,layout:{topStart:function(){let e=document.createElement("div");return e.innerHTML="<h2>Approved</h2><p>"+approvedTableCount+" approved quotes",e},bottomStart:"pageLength"}})},approvalDisapproved:()=>{$("#dashboard-approve-disapproved-table").DataTable({ajax:{url:"/index/approval/disapproved",dataSrc:""},responsive:!0,processing:!0,columns:[{data:"quote_id",render:function(e,t,a,d){return"<a target='_blank' href='/quote/"+e+"/edit'>"+e+"</a>"}},{data:"project_name"},{data:"architect_name"},{data:"customer_name"},{data:"owner_name"},{data:"market_segment_desc"},{data:"quote_date",render:function(e){return new Date(e).toLocaleDateString()}},{data:"expire_date",render:function(e){let t=new Date(e);return t<=new Date?'<span class="red">'+t.toLocaleDateString()+"</span>":t.toLocaleDateString()}},{data:"ship_required_date",render:function(e){return new Date(e).toLocaleDateString()}},{data:"quote_status"},{data:"quote_id",render:function(e,t,a,d){return"<a target='_blank' href='/quote/edit/id/"+a.quote_id+"'><span class='button-wrap'><span class='icon icon-edit'></span></span></a>"}}],columnDefs:[{targets:"_all",className:"dt-head-center"},{targets:[0,2,4,5,6,7,8,9,10],className:"dt-body-center"}],order:[[0,"desc"]],fixedColumns:{start:1,end:1},scrollX:!0,layout:{topStart:function(){let e=document.createElement("div");return e.innerHTML="<h2>Disapproved</h2><p>"+disapprovedTableCount+" disapproved quotes",e},bottomStart:"pageLength"}})},architectAll:()=>{$("#architect-all-table").DataTable({ajax:{url:"/index/architect/all",dataSrc:""},processing:!0,responsive:!0,columns:[{data:"architect_id",render:function(e,t,a,d){return"<a target='_blank' href='/architect/"+a.architect_id+"/edit'>"+e+"</a>"}},{data:"architect_name"},{data:"architect_rep_id"},{data:"architect_type_desc"},{data:"class_id"},{data:"date_added.date",render:function(e){return new Date(e).toLocaleDateString()}}],columnDefs:[{targets:"_all",className:"dt-head-center"},{targets:[0,2,3,4,5],className:"dt-body-center"}],order:[[0,"desc"]],fixedColumns:{start:1,end:1},scrollX:!0,layout:{topStart:null,topEnd:null,bottomStart:"search"}})},architectTop5:()=>{$("#top-5-architect-table").DataTable({ajax:{url:"/index/architect/topfive",dataSrc:""},processing:!0,responsive:!0,columns:[{data:"rank"},{data:"architect_name",render:function(e,t,a,d){return"<a target='_blank' href='/architect/"+a.architect_id+"/edit'>"+e+"</a>"}}],columnDefs:[{targets:"_all",className:"dt-head-center"},{targets:[0],className:"dt-body-center"}],order:[[0,"desc"]],scrollX:!0,layout:{topStart:null,topEnd:null,bottomStart:null,bottomEnd:null}})},projectNote:()=>{X=$("#note-table").DataTable({ajax:{url:"/note/table",data:{id:q},dataSrc:""},processing:!0,responsive:!0,columns:[{data:"date_added.date",render:function(e){return"<p><b>"+new Date(e).toLocaleDateString("en-CA")+"</b></p>"}},{data:"note_title",render:function(e,t,a,d){if(e=="")return"<p>"+a.project_note.replace(/(?:\r\n|\r|\n)/g,"<br>")+"</p>";if(a.project_note==null)return"<p>"+e+"</p>";{let r=a.project_note.replace(/(?:\r\n|\r|\n)/g,"<br>");return"<p><b>"+e+"</b></br>"+r+"</p>"}}},{data:"next_action",render:function(e){return"<p>"+e.replace(/(?:\r\n|\r|\n)/g,"<br>")+"</p>"}},{data:"follow_up_date.date",render:function(e){return e?"<p><b>"+new Date(e).toLocaleString("en-CA")+"</b></p>":"<p><b>--</b></p>"}},{data:"owner_id",render:function(e){return e!=null?"<p><b>"+e+"</b></p>":e}},{data:"project_note_id",render:function(e){return isOwner?'<div class="row-button"><a title="Edit this note" class="note-edit" href="/note/fetch?id='+e+'"><span class="button-wrap"><span class="icon icon-edit"></span></span></a><a title="Delete this note" class="note_delete" target="_blank" href="/note/delete?note_id='+e+'"><span class="button-wrap"><span class="icon icon-delete"></span></span></a></div>':null}}],columnDefs:[{targets:"_all",className:"dt-head-center"},{targets:[0,3,4,5],className:"dt-body-center"}],order:[[0,"desc"]],scrollX:!0,fixedColumns:{end:1}})},item:()=>{R=$("#item-table").DataTable({ajax:{url:"/item/table",data:{id:q,type:D},dataSrc:""},processing:!0,responsive:!0,columns:[{data:"item_id",render:function(e,t,a,d){return'<b class="item-name">'+e+"</b><br>"+a.item_desc}},{data:"quantity",render:function(e){return"<b>"+Number.parseFloat(e).toFixed(0)+"</b>"}},{data:"unit_price",render:function(e){return"<b>"+e+"</b>"}},{data:"uom",render:function(e){return"<b>"+e+"</b>"}},{data:"subtotal",render:function(e){return"<b>"+e+"</b>"}},{data:"note",render:function(e){return"<p>"+e.replace(/(?:\r\n|\r|\n)/g,"<br>")+"</p>"}},{data:"item_uid",render:function(e){return'<div class="row-button"><a title="Edit this item" class="item-edit" href="/item/fetch?uid='+e+"&type="+D+'"><span class="button-wrap"><span class="icon icon-edit"></span></span></a><a title="Delete this item" class="item_delete" href="/item/delete?uid='+e+"&type="+D+'"><span class="button-wrap"><span class="icon icon-delete"></span></span></a></div>'}}],columnDefs:[{targets:"_all",className:"dt-head-center"},{targets:[0,1,2,3,4],className:"dt-body-center"}],layout:{topStart:null,topEnd:null},order:[[7,"desc"]],paging:!1,scrollX:!0,fixedColumns:{start:1,end:1}})},projectQuote:()=>{$("#project-quote-table").DataTable({ajax:{url:`/project/${q}/quotetable`,dataSrc:""},processing:!0,responsive:!0,columns:[{data:"quote_id",render:function(e,t,a,d){return"<a target='_blank' href='/quote/"+e+"/edit'>"+e+"</a>"}},{data:"customer_name"},{data:"contact_full_name"},{data:"quote_date.date",render:function(e){return new Date(e).toLocaleDateString()}},{data:"expire_date.date",render:function(e){let t=new Date(e);return t<=new Date?'<span class="red">'+t.toLocaleDateString()+"</span>":t.toLocaleDateString()}},{data:"ship_required_date.date",render:function(e){return e?"<p>"+new Date(e).toLocaleDateString("en-CA")+"</p>":"<p>--</p>"}},{data:"quote_status",render:function(e){return e=="Dissapproved"?'<span class="disapproved red">Disapproved</span>':e=="Approved"?'<span class="approved green">Approved</span>':e=="Waiting"?'<span class="waiting orange">Waiting</span>':"Draft"}},{data:"order_no"}],columnDefs:[{targets:"_all",className:"dt-head-center"},{targets:[0,2,3,4,5,6,7],className:"dt-body-center"}],order:[[0,"desc"]],scrollX:!0,layout:{topStart:null,topEnd:null}})}};function J(){$(".sTable").each(function(){const e=$(this),t=e.data("init");if(!t||!(t in K)){console.warn(`No DataTable config found for: ${t}`);return}$.fn.DataTable.isDataTable(e)&&e.DataTable().destroy(),K[t]()})}function W(e){e.find("input:hidden, input:text, input:password, input:file, select, textarea").val("").trigger("change"),e.find("input:radio, input:checkbox").prop("checked",!1).prop("selected",!1).trigger("change"),e.find("select").each(function(){let t=$(this);t.data("default-options")&&t.html(t.data("default-options")),t.prop("selectedIndex",0).trigger("change")}),e.find("input, select, textarea").prop("disabled",!1)}function g(e,t){e.prop("disabled",t)}function te(){flatpickr(".flatpickr",{dateFormat:"Y-m-d"})}function Z(){const e=document.querySelectorAll(".fade-in-up:not(.show)");if(!("IntersectionObserver"in window)){e.forEach(a=>a.classList.add("show"));return}const t=new IntersectionObserver((a,d)=>{a.forEach(r=>{r.isIntersecting&&(r.target.classList.add("show"),d.unobserve(r.target))})},{threshold:.1});e.forEach(a=>t.observe(a))}function k({fieldName:e,fetchUrl:t,fillFields:a=[],renderItem:d=defaultRenderItem,extraSelectActions:r=[],minLength:p=1,queryParamName:o="pattern",limitParamName:n="limit"}){const i=document.querySelector(e);if(!i)return;let c=document.createElement("ul");c.classList.add("autocomplete-list"),i.parentNode.style.position="relative",document.body.appendChild(c);let m=-1,h=null;i.addEventListener("input",function(){clearTimeout(h),h=setTimeout(()=>{const f=i.value.trim();if(m=-1,f.length<p)return;const y=`${t}?${o}=${encodeURIComponent(f)}&${n}=10`;fetch(y).then(x=>x.json()).then(x=>{if(c.classList.add("visible"),c.innerHTML="",!x.length){const v=document.createElement("li");v.textContent="No matches found.",v.classList.add("no-result"),c.appendChild(v);return}x.forEach((v,s)=>{const l=document.createElement("li");l.innerHTML=d(v),l.setAttribute("data-index",s),l.addEventListener("click",function(){a.forEach(({fieldSelector:u,itemKey:_})=>{const T=document.querySelector(u);T&&v[_]!==void 0&&(T.value=v[_])}),r.forEach(u=>{typeof u=="function"&&u(v)}),c.classList.remove("visible"),c.innerHTML=""}),c.appendChild(l)}),w()}).catch(x=>{c.innerHTML="",console.error("Autocomplete fetch error:",x)})},300)}),i.addEventListener("keydown",function(f){const y=c.querySelectorAll("li:not(.no-result)");y.length&&(f.key==="ArrowDown"?(f.preventDefault(),m=(m+1)%y.length,b(y)):f.key==="ArrowUp"?(f.preventDefault(),m=(m-1+y.length)%y.length,b(y)):f.key==="Enter"?(f.preventDefault(),m>-1&&y[m].click()):f.key==="Escape"&&(c.innerHTML=""))}),document.addEventListener("click",function(f){f.target!==i&&!c.contains(f.target)&&(c.innerHTML="")}),window.addEventListener("scroll",()=>{document.activeElement===i&&w()},!0),window.addEventListener("resize",()=>{document.activeElement===i&&w()});function b(f){f.forEach(y=>y.classList.remove("active")),m>-1&&f[m]&&(f[m].classList.add("active"),f[m].scrollIntoView({block:"nearest"}))}function w(){const f=i.getBoundingClientRect();c.style.position="absolute",c.style.top=`${f.bottom+window.scrollY}px`,c.style.left=`${f.left+window.scrollX}px`,c.style.width=`${f.width}px`,c.style.zIndex="10000"}}let A=!1;const I=$("#dialog-item"),F=$("#dialog-item-form"),j=$("#item-form-btn-add"),C=$("#uom");C.data("default-options",C.html());function ae(){const e=document.getElementById("uom");$(document).on("click","a.item-edit",function(o){o.preventDefault(),A=!0,I.dialog("option","title","Edit Item"),I.dialog("open"),j.text("Save Changes"),$.ajax({url:$(this).attr("href"),type:"GET",dataType:"json"}).done(n=>{if(n.success&&n.data){const i=n.data;$("#dialog-item-form #item_uid").val(i.item_uid||""),$("#dialog-item-form #item_id").val(i.item_id||""),$("#dialog-item-form #quantity").val(i.quantity||""),$("#dialog-item-form #note").val(i.note||""),$("#dialog-item-form #uom").val(i.uom||""),t(i.item_id,i.uom,i.unit_price,i.item_uid)}else alert(n.message||"Failed to fetch item data.")}).fail((n,i,c)=>{console.error("Error deleting item:",i,c,n.responseText)})}),$("#widget-btn-add-item").on("click",function(){A=!1,I.dialog("option","title","Add Item"),I.dialog("open"),j.text("Add Item")}),$("#dialog-item").dialog({autoOpen:!1,modal:!0,minWidth:800,width:800,open:function(){W(F),$(".ui-widget-overlay").hide().fadeIn().css("z-index",1e3),$(".ui-dialog").css("z-index",2e3)},beforeClose:function(){$(".ui-widget-overlay").fadeOut(400,function(){$(this).remove()})},dialogClass:"add-item-dialog",buttons:[{id:"item-form-btn-add",text:"Save",click:function(){F.validationEngine("validate")&&(g(j,!0),A?p():r(),$(this).dialog("close"),setTimeout(()=>g(j,!1),1e3))},"aria-label":"Add Item"},{id:"item-form-btn-cancel",text:"Cancel",click:function(){$(this).dialog("close")},"aria-label":"Cancel"}]}),document.querySelector(".dialog #item_id")&&k({fieldName:".dialog #item_id",fetchUrl:"/item/index",fillFields:[{fieldSelector:"#item_id",itemKey:"item_id"},{fieldSelector:"#item_input",itemKey:"item_desc"}],minLength:2,queryParamName:"term",limitParamName:"limit",renderItem:o=>`
      <div class="autocomplete-item">
        <strong>${o.item_id}</strong><br>
        <span>${o.item_desc}</span>
      </div>`,extraSelectActions:[o=>{o.item_id&&(t(o.item_id),e.disabled=!1,e.classList.remove("disabled"))}]}),C.on("change",function(){a($("#item_id").val(),$("#uom").val())});function t(o,n=null,i=null,c=null){o&&$.ajax({url:"/item/uom",dataType:"json",data:{term:o},type:"get"}).done(function(m){C.empty(),$.each(m,function(h,b){let w=$("<option></option>").attr("value",b.uom).text(b.uom);n&&b.uom===n&&w.attr("selected","selected"),C.append(w)}),A?d(c,D):a(o,n||$("#uom").val(),i)}).fail((m,h,b)=>{console.error("Error fetching specifier:",h,b)})}function a(o,n,i=null){!o||!n||$.ajax({url:"/item/price",data:{item_id:o,uom:n},dataType:"json"}).done(c=>{$("#unit_price").val((c==null?void 0:c.price)||i||"")}).fail((c,m,h)=>{console.error("Error fetching price:",m,h)})}function d(o,n){o&&$.ajax({url:"/item/quotedprice",data:{item_uid:o,type:n},dataType:"json"}).done(i=>{$("#unit_price").val((i==null?void 0:i.unit_price)||"")}).fail((i,c,m)=>{console.error("Error fetching price:",c,m)})}function r(){g(j,!0);let o=F.serialize()+"&project_id="+encodeURIComponent(q)+"&type="+encodeURIComponent(D);$.ajax({url:"/item/add",type:"post",data:o,contentType:"application/x-www-form-urlencoded"}).done(n=>{R.ajax.reload(),U(n.message,n.success)}).fail((n,i,c)=>{console.error("Error adding item:",i,c,n.responseText),alert("Failed to add item. Please try again.")}).always(()=>g(j,!1))}function p(){g(j,!0);let o=F.serialize()+"&type="+encodeURIComponent(D);$.ajax({url:"/item/edit",type:"post",data:o,contentType:"application/x-www-form-urlencoded"}).done(n=>{R.ajax.reload(),U(n.message,n.success)}).fail((n,i,c)=>{console.error("Error adding item:",i,c,n.responseText),alert("Failed to edit item. Please try again.")}).always(()=>g(j,!1))}$(document).on("click",".item_delete",function(o){o.preventDefault(),confirm("Are you sure you want to delete this item?")&&$.ajax({url:$(this).attr("href"),type:"GET"}).done(()=>R.ajax.reload()).fail((n,i,c)=>{console.error("Error deleting item:",i,c,n.responseText)})})}const P=$("#dialog-note-form"),H=$("#dialog-message"),S=$("#note-form-btn-add");let B=!1,Y=flatpickr("#dialog-note-form #follow_up_date",{enableTime:!0,dateFormat:"Y-m-d H:i"});function ne(){$("#dialog-message").dialog({autoOpen:!1,modal:!0,minWidth:800,width:1e3,height:650,open:function(){W(P),$(".ui-widget-overlay").hide().fadeIn().css("z-index",1e3),$(".ui-dialog").css("z-index",2e3)},beforeClose:function(){$(".ui-widget-overlay").fadeOut(400,function(){$(this).remove()})},dialogClass:"add-note-dialog",buttons:[{id:"note-form-btn-add",text:"Add Log",click:function(){P.validationEngine("validate")&&(B?t():e(),$(this).dialog("close"),setTimeout(()=>g(S,!1),1e3))},"aria-label":"Add Log"},{id:"note-form-btn-cancel",text:"Cancel",click:function(){$(this).dialog("close")},"aria-label":"Cancel"}]}),$(document).on("click",".note-edit",function(a){a.preventDefault(),B=!0,H.dialog("option","title","Edit Log"),H.dialog("open"),S.text("Save Changes"),$.ajax({url:$(this).attr("href"),type:"GET",dataType:"json"}).done(d=>{if(d.success&&d.data){const r=d.data;$("#dialog-note-form #note_id").val(r.project_note_id||""),$("#dialog-note-form #note_title").val(r.note_title||""),$("#dialog-note-form #project_note").val(r.project_note||""),$("#dialog-note-form #next_action").val(r.next_action||""),r.follow_up_date?Y.setDate(r.follow_up_date.date):Y.clear()}else alert(d.message||"Failed to fetch note data.")}).fail((d,r,p)=>{console.error("Error fetch note data:",r,p,d.responseText)})}),$("#widget-btn-add-note").on("click",function(){B=!1,H.dialog("option","title","Add Log"),H.dialog("open"),S.text("Add Note")});function e(){g(S,!0);let a=P.serialize()+"&project_id="+encodeURIComponent(q);$.ajax({url:"/note/add",type:"post",data:a,contentType:"application/x-www-form-urlencoded"}).done(d=>{X.ajax.reload(),U(d.message,d.success)}).fail((d,r,p)=>{console.error("Error adding note:",r,p,d.responseText),alert("Failed to add note. Please try again.")}).always(()=>g(S,!1))}function t(){g(S,!0);let a=P.serialize();$.ajax({url:"/note/edit",type:"post",data:a,contentType:"application/x-www-form-urlencoded"}).done(()=>{X.ajax.reload(),U(response.message,response.success)}).fail((d,r,p)=>{console.error("Error editing note:",r,p,d.responseText),alert("Failed to edit note. Please try again.")}).always(()=>g(S,!1))}$(document).on("click",".note_delete",function(a){a.preventDefault(),confirm("Are you sure you want to delete this log?")&&$.ajax({url:$(this).attr("href"),type:"get"}).done(()=>X.ajax.reload()).fail((d,r,p)=>{console.error("Error deleting item:",r,p,d.responseText)})})}const ee={unsave:!1,lastChanged:null},re=new Set;function oe(){return{...ee}}function L(e){Object.assign(ee,e),re.forEach(t=>t(oe()))}function ie(){const e=document.querySelector("#architect-details"),t=document.querySelector("#architect_name"),a=document.querySelector("#contractor-details"),d=document.querySelector("#general_contractor_name"),r=document.querySelector("#awarded_contractor_name");k({fieldName:"#shared_id",fetchUrl:"/user/fetchbypattern",fillFields:[{fieldSelector:"#shared_id",itemKey:"id"}],renderItem:s=>`<div><strong>${s.id}</strong><br>${s.name}</div>`}),e&&t.value.trim()!==""&&(e.open=!0),a&&(d.value.trim()!==""||r.value.trim()!=="")&&(a.open=!0),z&&z.addEventListener("change",()=>{document.querySelector("#form-btn-save-project").disabled=!1,L({unsave:!0,lastChanged:"project"})});const p=document.getElementById("#form-btn-save-project");p&&p.addEventListener("click",async s=>{if(z.checkValidity()&&(s.preventDefault(),window.jQuery&&window.jQuery(E).validationEngine("validate"))){d.value.trim()===""&&(document.querySelector("#general_contractor_id").value=""),r.value.trim()===""&&(document.querySelector("#awarded_contractor_id").value=""),document.querySelector(".loading").style.display="block",L({unsave:!1});try{const u=await(await fetch(E.action,{method:E.method,body:new URLSearchParams(new FormData(E)),headers:{Accept:"application/json"}})).json();u.success?window.location.href=u.redirect:alert(u.message||"Failed to save project.")}catch(l){console.error("Save failed:",l),alert("An error occurred while saving the project.")}finally{document.querySelector(".loading").style.display="none"}}}),document.querySelectorAll(".delete_pro").forEach(s=>{s.addEventListener("click",async()=>{if(confirm("Are you sure you want to delete this project?")){document.querySelector(".loading").style.display="block";try{const u=await(await fetch(`/project/${q}/delete`)).json();u.success?window.location.href="/index/project":alert(u.message||"Failed to delete the project.")}catch(l){console.error("Delete failed:",l),alert("Error occurred while deleting the project.")}finally{document.querySelector(".loading").style.display="none"}}})});let o=$("#architect_name, #architect_id, #architect_company_id, #architect_rep_id, #architect_type_id, #architect_class_id"),n=$("#address_list"),i=$("#address_id, #address_name, #phys_address1, #phys_address2, #phys_city, #phys_state, #phys_postal_code, #phys_country, #central_phone_number, #email_address, #url"),c=$("#specifier_name"),m=$("#specifier_id, #specifier_address_id, #specifier_first_name, #specifier_last_name, #specifier_job_title, #specifier_phone_number, #specifier_email");$("#add_architect").on("click",function(){[o,i,m].forEach(s=>s.val("").prop("readonly",!1)),[n,c].forEach(s=>s.html('<option value="">-- Please search for an architect first --</option>'))}),k({fieldName:"#architect_name",fetchUrl:"/architect",fillFields:[],minLength:2,queryParamName:"search",limitParamName:"limit",renderItem:s=>`
    <div class="autocomplete-item">
      <strong>${s.architect_name}</strong><br>
      <span>${s.architect_rep_id} - ${s.company_id}</span>
    </div>`,extraSelectActions:[s=>{s.architect_id&&(h(s.architect_id),b(s.architect_id),w(s.architect_id))}]});function h(s){s&&$.ajax({url:`/architect/${s}/fetchfull`,dataType:"json",type:"get"}).done(function(l){l?o.each(function(){let u=$(this).attr("id");$(this).val(l[u]||""),$("#architect_company_id").val(l.company_id),$("#architect_name").prop("readonly",!1)}):(o.val("").prop("readonly",!1),console.warn("No architect data found for ID:",s))}).fail(function(l,u,_){console.error("Error fetching architect details:",u,_)})}function b(s){s&&$.ajax({url:`/architect/${s}/address`,dataType:"json",type:"get"}).done(function(l){if(n.empty(),!l||l.length===0){n.html('<option value="">No addresses found, please add.</option>'),i.val("").prop("readonly",!1);return}else $.each(l,function(u,_){n.append('<option value="'+_.address_id+'">'+_.name+"</option>")}),n.append('<option value="new">+ Add New Address</option>'),n.prop("selectedIndex",0),y()}).fail(function(l,u,_){console.error("Error fetching address:",u,_)})}function w(s){s&&$.ajax({url:`/architect/${s}/fetchspecs`,dataType:"json",type:"get"}).done(function(l){if(c.empty(),!l||l.length===0){$("#specifier_name").html('<option value="">No specifiers found, please add.</option>'),m.val("").prop("readonly",!1);return}else $.each(l,function(u,_){c.append('<option value="'+_.specifier_id+'">'+_.first_name+" "+_.last_name+"</option>")}),c.append('<option value="new">+ Add New Specifier</option>'),c.prop("selectedIndex",0),f()}).fail(function(l,u,_){console.error("Error fetching specifier:",u,_)})}$("#specifier_name").on("change",function(){$(this).val()==="new"?(m.val(""),m.prop("readonly",!1)):f()}),$("#address_list").on("change",function(){$(this).val()==="new"?(i.val(""),i.prop("readonly",!1)):y()});function f(){let s=$("#specifier_name").val();!s||s==="new"||$.ajax({url:`/architect/${s}/specinfo`,dataType:"json",type:"get"}).done(function(l){l&&m.each(function(){let u=$(this).attr("id");$(this).val(l[u]||""),$("#specifier_address_id").val(l.address_id),$("#specifier_first_name").val(l.first_name),$("#specifier_last_name").val(l.last_name),$("#specifier_job_title").val(l.job_title),$("#specifier_phone_number").val(l.central_phone_number),$("#specifier_email").val(l.email_address)})}).fail(function(l,u,_){console.error("Error fetching specifier details:",u,_)})}function y(){let s=$("#address_list").val();!s||s==="new"||$.ajax({url:`/architect/${s}/addressinfo`,dataType:"json",type:"get"}).done(function(l){l&&i.each(function(){let u=$(this).attr("id");$(this).val(l[u]||""),$("#address_name").val(l.name)})}).fail(function(l,u,_){console.error("Error fetching specifier details:",u,_)})}[{fieldName:"#general_contractor_name",targetPrefix:"general_contractor"},{fieldName:"#awarded_contractor_name",targetPrefix:"awarded_contractor"}].forEach(({fieldName:s,targetPrefix:l})=>{k({fieldName:s,fetchUrl:"/customer",fillFields:[],minLength:2,queryParamName:"search",limitParamName:"limit",renderItem:u=>`
        <div class="autocomplete-item">
          <strong>${u.customer_id} - ${u.company_id}</strong><br>
          <span>${u.customer_name}</span>
        </div>`,extraSelectActions:[u=>{u.customer_id&&v(u.customer_id,l)}]})});function v(s,l){fetch(`/customer/${s}/fetchbyid`).then(u=>u.json()).then(u=>{if(u){const _=document.getElementById(`${l}_id`),T=document.getElementById(`${l}_name`);_&&(_.value=u.customer_id),T&&(T.value=u.customer_name)}}).catch(u=>{console.error(`Failed to fetch contractor (${s}):`,u)})}}const G=$("#dialog-make-quote-form"),Q=$("#dialog-make-quote"),M=$("#customer-form-btn-add");$("#customer_id, #customer_name, #company_id, #salesrep_full_name");let V=$("#contact_name");$("#contact_id, #first_name, #last_name, #phys_address1, #phys_address2, #phys_city, #phys_state, #phys_postal_code, #phys_country, #central_phone_number, #email_address");V.data("default-options",V.html());function de(){N.on("change",function(){$("#form-btn-save-quote").prop("disabled",!1),L({unsave:!0,lastChanged:"quote"})}),$("#form-btn-save-quote").on("click",function(r){r.preventDefault(),N.trigger("submit"),L({unsave:!1})}),$(".quote-action-button").on("click",async function(r){var m;r.preventDefault();const p=$(this),o=p.data("action"),n=(m=p.data("label"))==null?void 0:m.toLowerCase();if(!o||["submit","approve","submit-approve"].includes(o)&&!N.validationEngine("validate")||!confirm(`You are about to ${n} this quote. Continue?`))return;p.prop("disabled",!0),L({unsave:!1});let c=N.serialize();$(".loading").show();try{const h=await $.post(`/quote/${O}/${o}`,c);h.success?(window.scrollTo(0,0),location.reload()):alert(h.message||`Failed to ${n} the quote.`)}catch(h){console.error("Submit failed:",h),alert(`Error occurred while trying to ${n} the quote.`)}finally{$(".loading").hide(),setTimeout(()=>p.prop("disabled",!1),1e3)}}),$(".delete_quote").on("click",async function(r){if(r.preventDefault(),confirm("Are you sure you want to delete this quote?")==!0){L({unsave:!1}),$(".loading").show();try{const p=await $.ajax({url:`/quote/${O}/delete`,type:"GET",dataType:"json"});p.success?window.location.href="/index/project":alert(p.message||"Failed to delete the quote.")}catch(p){console.error("Delete failed:",p),alert("Error occurred while deleting the quote.")}finally{$(".loading").hide()}}}),$("a.quote-edit-again").on("click",function(r){confirm("You are about to edit this approved quote. Continue?")==!0?(r.preventDefault(),$(".loading").show(),$.ajax({url:`/quote/${O}/edit`,type:"get",success:function(p){location.reload()}}),$(".loading").hide()):r.preventDefault()}),Q.dialog({autoOpen:!1,modal:!0,minWidth:800,width:1200,height:650,open:function(){W(G),$(".ui-widget-overlay").hide().fadeIn().css("z-index",1e3),$(".ui-dialog").css("z-index",2e3)},beforeClose:function(){$(".ui-widget-overlay").fadeOut(400,function(){$(this).remove()})},dialogClass:"add-customer-dialog",buttons:[{id:"customer-form-btn-add",text:"Make Quote",click:function(){G.validationEngine("validate")&&(g(M,!0),d(),$(this).dialog("close"),setTimeout(()=>g(M,!1),1e3))},"aria-label":"Make Quote"},{id:"customer-form-btn-cancel",text:"Cancel",click:function(){$(this).dialog("close")},"aria-label":"Cancel"}]}),$("#widget-btn-add-quote, .make-quote").on("click",function(r){r.preventDefault(),Q.dialog("open")});function e(r){const p=r.querySelector("input[id$='_customer_name']"),o=r.dataset.type;k({fieldName:`#${p.id}`,fetchUrl:"/customer",fillFields:[{fieldSelector:`#${o}_customer_id`,itemKey:"customer_id"},{fieldSelector:`#${o}_customer_name`,itemKey:"customer_name"},{fieldSelector:`#${o}_company_id`,itemKey:"company_id"},{fieldSelector:`#${o}_salesrep_full_name`,itemKey:"salesrep_full_name"}],minLength:2,queryParamName:"search",limitParamName:"limit",renderItem:n=>`<div>
        <b>${n.customer_id}</b> - ${n.customer_name} - 
        <small>${n.from_P21}</small>
      </div>`,extraSelectActions:[n=>{n.customer_id&&t(n.customer_id,r)}]})}function t(r,p){r&&fetch(`/customer/${r}/contacts`).then(o=>o.json()).then(o=>{const n=p.querySelector("select[id$='_contact_name']");n&&(n.innerHTML="",o.forEach(i=>{const c=document.createElement("option");c.value=i.contact_id,c.textContent=i.contact_full_name,n.appendChild(c)}),a(p))}).catch(o=>{console.error("Failed to fetch contacts:",o)})}function a(r){const p=r.querySelector("select[id$='_contact_name']"),o=p==null?void 0:p.value;o&&fetch(`/customer/${o}/contactinfo`).then(n=>n.json()).then(n=>{const i=r.dataset.type;["contact_id","first_name","last_name","phys_address1","phys_address2","phys_city","phys_state","phys_postal_code","phys_country","central_phone_number","email_address"].forEach(m=>{const h=document.getElementById(`${i}_${m}`);h&&(h.value=n[m]||"")})}).catch(n=>{console.error("Failed to fetch contact info:",n)})}document.querySelectorAll(".customer-section").forEach(r=>{e(r);const p=r.querySelector("select[id$='_contact_name']");p&&p.addEventListener("change",()=>a(r))});function d(){g(M,!0);let r=$("#dialog_contact_id").val(),p="";D==="project"&&(p=E.serialize()+"&contact_id="+encodeURIComponent(r)+"&project_id="+encodeURIComponent(q)),D==="quote"&&(p="&contact_id="+encodeURIComponent(r)+"&project_id="+encodeURIComponent($("#project_id").val())),$(".loading").show(),$.ajax({url:"/quote",type:"post",data:p,contentType:"application/x-www-form-urlencoded",dataType:"json"}).done(o=>{o.success&&o.quote_id?window.location.href=`/quote/${o.quote_id}/edit`:alert(o.message||"Failed to make quote. Please try again.")}).fail((o,n,i)=>{console.error("Error making quote:",n,i,o.responseText),alert("Failed to make quote. Please try again.")}).always(()=>{g(M,!1),$(".loading").hide()})}}document.body.addEventListener("htmx:afterSwap",function(e){e.target.id==="content"&&(J(),setTimeout(Z,50))});document.addEventListener("DOMContentLoaded",()=>{J(),te(),ae(),ne(),ie(),de(),Z(),new URLSearchParams(window.location.search).get("open")==="make-quote"&&Q.dialog("open"),document.querySelectorAll(".top-level-entry").forEach(a=>{a.addEventListener("click",function(){document.querySelectorAll(".top-level-entry").forEach(d=>d.classList.remove("active")),this.classList.add("active")})})});

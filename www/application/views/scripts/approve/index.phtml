<?php
$session =  Zend_Registry::get('session');
$project = $this->project;
$quote = $this->quote;
?>

<!-- Main content-->
<main id="content" class="main-content">
	<div class="main-page-content">
		<header class="main-page-content-header">
			<h1>Quote Approval</h1>
		</header>

		<div class="widget-information">
			<div class="widget-table dashboard">
				<span class='svg icon icon-list'></span>
				<div class="project-information project-name">
					<h2><?= $project['project_name'] ?></h2>
					<p><?= ($project['project_location_address'] == 'N/A') ? '' : $project['project_location_address'] ?></p>
					</br>
					<p>by <b><?= $project['owner'] ?></b></p>
				</div>
			</div>

			<div class="widget-table dashboard">
				<span class='svg icon icon-number'></span>
				<div class="project-information">
					<p>Quote number</p>
					<h2><?= $project['quote_no'] ?></h2>
				</div>
			</div>

			<div class="widget-table dashboard">
				<span class='svg icon icon-money-1'></span>
				<div class="project-information">
					<p>Project status</p>
					<h2><?= $project['status_name'] ?></h2>
				</div>
			</div>

			<div class="widget-table dashboard">
				<span class='svg icon icon-calender'></span>
				<div class="project-information">
					<p>Due date</p>
					<h2><?= $project['due_date']->format('Y-m-d') ?></h2>
				</div>
			</div>

			<?php
			switch ($quote['approve_status']) {
				case 10: ?>
					<div class="widget-table dashboard quote-status status-approved">
						<div class="project-information">
							<p>Quote status</p>
							<h2>Approved</h2>
						</div>
						<span class='svg icon icon-checkmark-circle'></span>
					</div>
				<?php break;

				case 1: ?>
					<div class="widget-table dashboard quote-status status-waiting">
						<div class="project-information">
							<p>Quote status</p>
							<h2>Waiting for approval</h2>
						</div>
						<span class='svg icon icon-information-circle'></span>
					</div>
				<?php break;

				case -1: ?>
					<div class="widget-table dashboard quote-status status-disapproved">
						<div class="project-information">
							<p>Quote status</p>
							<h2>Disapproved</h2>
						</div>
						<span class='svg icon icon-cancel-circle'></span>
					</div>
				<?php break;

				default: ?>
					<div class="widget-table dashboard quote-status status-notsubmitted">
						<div class="project-information">
							<p>Quote status</p>
							<h2>Not submitted</h2>
						</div>
						<span class='svg icon icon-cancel-circle'></span>
					</div>
			<?php break;
			} ?>
		</div>

		<div class="middleNav">
			<ul>
				<li class="mUser"><a href="#" title="Share"><span class="users"></span></a>
					<ul class="mSub1">
						<li><a href="#" title="">Share user</a></li>
						<li><a href="#" title="">Show Teamworks</a></li>
					</ul>
				</li>

				<li class="mOrders"><a href="#" title="Change Status"><span class="files"></span></a>
					<ul class="mSub4">
						<li><a href="#" title="">Add</a></li>
						<li><a href="#" title="">Save</a></li>
						<li><a href="#" title="">Edit</a></li>
						<li><a href="#" title="">Delete</a></li>
					</ul>
				</li>
			</ul>
		</div>

		<!-- Form -->
		<form method='post' class="form" id="quote_content">
			<div class="widget-table" id="customer_info">
				<h2>Customer Infomation</h2>
				<input type="hidden" id="project_id" name='project_id' value="<?= $project['project_id'] ?>" />
				<div class="formRow">
					<div class="oneTwo">
						<label for='quote'>Quote To</label>
						<input readonly type="text" id='quote' name='name' value="<?= $this->customer['name'] ?>" />
					</div>

					<div class="oneTwo">
						<label for="customer_id">Customer ID</label>
						<input readonly type="text" name='customer_id' id='customer_id' value="<?= $this->customer['customer_id'] ?>" />
					</div>

					<div class="oneTwo">
						<label for="company_id">Company ID</label>
						<input readonly type="text" name='company_id' id='company_id' value="<?= $this->customer['company_id'] ?>" />
					</div>

					<div class="oneTwo">
						<label for="first_name">First Name</label>
						<input readonly id='first_name' name='first_name' type="text" value="<?= $this->customer['first_name'] ?>">
					</div>

					<div class="oneTwo">
						<label for="last_name">Last Name</label>
						<input readonly id='last_name' name='last_name' type="text" value="<?= $this->customer['last_name'] ?>">
					</div>

					<div class="oneTwo required-field">
						<label for="address">Address 1</label>
						<input readonly id='address' name='phys_address1' type="text" value="<?= $this->customer['phys_address1'] ?>" />
					</div>

					<div class="oneTwo">
						<label for="phys_address2">Address 2</label>
						<input readonly id='phys_address2' name='phys_address2' type="text" value="<?= $this->customer['phys_address2'] ?>">
					</div>

					<div class="oneTwo">
						<label for="phys_city">City</label>
						<input readonly id='phys_city' name='phys_city' type="text" value="<?= $this->customer['phys_city'] ?>">
					</div>

					<div class="oneTwo">
						<label for="mail_state">Province</label>
						<input readonly id='mail_state' name='mail_state' type="text" value="<?= $this->customer['mail_state'] ?>">
					</div>

					<div class="oneTwo">
						<label for="mail_postal_code">Postal Code</label>
						<input readonly id='mail_postal_code' name='mail_postal_code' type="text" value="<?= $this->customer['mail_postal_code'] ?>">
					</div>

					<div class="oneTwo">
						<label for="phys_country">Country</label>
						<input readonly id='phys_country' name='phys_country' type="text" value="<?= $this->customer['phys_country'] ?>">
					</div>

					<div class="oneTwo required-field">
						<label for="tel">Phone Number</label>
						<input readonly id='tel' name='phone' type="text" class="maskPhoneExt" value="<?= $this->customer['tel'] ?>" />
					</div>

					<div class="oneTwo required-field">
						<label for="contact">Contact</label>
						<input readonly type="text" id='contact' name='fullname' value="<?= $this->customer['fullname'] ?>"/>
					</div>
					<div class="oneTwo required-field">
						<label for="customer_email">Email</label>
						<input readonly type="text" value="<?= $this->customer['email'] ?>" id='customer_email' name='Contacts_email' >
					</div>
				</div>

				<div class="line"></div>


				<h2>Quote Infomation</h2>
				<div class="formRow">
					<div class="oneTwo">
						<label for="quote_id">Quote Number</label>
						<input id="quote_id" type="text" value='<?= $quote['quote_id'] ?>' readonly />
					</div>
					<div class="oneTwo">
						<label for='quote_type'>Quote Type</label>
						<select name="quote_type_id" id='quote_type' class="validate[required]">
							<option value="">Select Quote type</option>
							<?php foreach ($this->type as $t) { ?>
								<option value="<?= $t['uid'] ?>" <?php if ($t['uid'] == $quote['quote_type_id']) echo 'selected'; ?>><?= $t['type'] ?></option>
							<?php } ?>
						</select>
					</div>
					<div class="oneTwo required-field">
						<label for='Segment'>Quote Segment</label>
						<select name="quote_segment" id='Segment' class="validate[required]">
							<option value="">Choose Segment</option>
							<?php foreach ($this->seg as $s) { ?>
								<option value="<?= $s['uid'] ?>" <?php if ($s['uid'] == $quote['quote_segment']) echo 'selected' ?>><?= $s['Market_Segment'] ?></option>
							<?php } ?>
						</select>
					</div>
					
					<div class="oneTwo">
						<label for="quote-date">Quote Date</label>
						<input id="quote-date" name="quote_date" type="text" class="datepicker" value="<?= $quote['quote_date']->format('Y-m-d') ?>" />
					</div>
					<div class="oneTwo">
						<label for="ship_required_date">Ship Required Date</label>
						<input id="ship_required_date" type="text" class="datepicker" name='ship_required_date' value="<?php
																														if ($quote['ship_required_date'] != null && $quote['ship_required_date']->format('Y-m-d') > '01/01/2000') {
																															echo $quote['ship_required_date']->format('Y-m-d');
																														} ?>" />
					</div>
					<div class="oneTwo">
						<label for="expire_date">Quote Expire Date</label>
						<input id="expire_date" type="text" class="datepicker" name='expire_date' value="<?php
																															if ($quote['expire_date'] == null || $quote['expire_date']->format('Y-m-d') < $quote['quote_date']->format('Y-m-d')) {
																																echo date('Y-m-d', strtotime($quote['quote_date']->modify('+60 days')->format('Y-m-d')));
																															} else {
																																echo $quote['expire_date']->format('Y-m-d');
																															}
																															?>" />
					</div>
					<div class="oneTwo required-field">
						<label for='arch'>Architectural Representative</label>
						<select id='arch' name="arch" class="validate[required]">
							<?php foreach ($this->arch as $a) { ?>
								<option value="<?= $a['id'] ?>" <?php if ($a['id'] == $quote['arch']) echo 'selected'; ?>><?= $a['name'] . ' - ' . $a['default_company'] ?></option>
							<?php } ?>
						</select>
						<input type="hidden" name="sales_id" value="<?= $session->user['id'] ?>" />
					</div>
					
					<div class="oneTwo required-field">
						<label for="quote_approval">Quote Approval</label>
						<?php if ($session->user['approve_id'] != null) { ?>
							<select name="quote_approval" id="quote_approval">
								<option value="">Select Approval</option>
								<?php foreach ($this->approval as $a) { ?>
									<option value="<?= $a['uid'] ?>" <?php if ($a['uid'] == $quote['quote_approval']) echo 'selected'; ?>><?= $a['Name'] . ' - ' . $a['Company_ID'] ?></option>
								<?php } ?>
							</select>
						<?php } else { ?>
							<select name="quote_approval" id="quote_approval">
								<?php foreach ($this->approval as $a) { ?>
									<?php if ($a['uid'] == $quote['quote_approval']) { ?><option value="<?= $a['uid'] ?>" selected><?= $a['Name'] . ' - ' . $a['Company_ID'] ?></option> <?php } ?>
								<?php } ?>
							</select>
						<?php } ?>
					</div>
					<div class="oneTwo">
						<label for='sale_rep'>Sale Representative</label>
						<input id='sale_rep' name='sale_rep' type="text" value="<?= $quote['sales_id'] ?>" readonly />
					</div>
					<div class="oneTwo required-field">
						<label for="credit_term">Credit Terms</label>
						<select name="credit_term" id="credit_term" class="validate[required]">
							<option value="">Select Terms</option>
							<?php foreach ($this->terms as $a) { ?>
								<option value="<?= $a['terms_desc'] ?>" <?php if ($this->userterm == $a['terms_desc'] && $quote['term'] == null) {
																			echo 'selected';
																		}
																		if ($quote['term'] == $a['terms_desc']) {
																			echo 'selected';
																		} ?>><?= $a['terms_desc'] ?></option>
							<?php } ?>
						</select>
					</div>
					<div class="oneTwo required-field">
						<label for="lead_time">Lead Time</label>
						<select name="lead_time" id="lead_time" class="validate[required]">
							<option value="">Select Lead Time</option>
							<?php foreach ($this->leadtime as $a) { ?>
								<option value="<?= $a['uid'] ?>" <?php if ($quote['lead_time'] == $a['uid']) {
																		echo 'selected';
																	} ?>><?= $a['description'] ?></option>
							<?php } ?>
						</select>
					</div>
				</div>

				<div class="line"></div>

				<h2>Comment</h2>
				<div class="formRow">
					<div class="oneTwo">
						<label for="quote-note">Quote Note</label>
						<textarea id="quote-note" rows="5" cols="" name="note" placeholder="Add quote note here..."><?= $quote['note'] ?></textarea>
					</div>
				</div>
			</div>
		</form>

		<section aria-labelledby="items" id="section4" data-nav="Items">
			<div class="widget-table">
				<div class="widget-button">
					<button type="button" title="Add new item" class="button action has-icon add-item-button small" id="opener">
						<span class="button-wrap">
							<span class="icon icon-add"></span>
							Add Item
						</span>
					</button>
				</div>
				<h2>Items</h2>
				<table width="100%" class="sTable display nowrap" id="items">
					<thead>
						<tr>
							<th data-priority="1">Item</th>
							<th data-priority="1">Quality Quoted</th>
							<th data-priority="1">Unit Price</th>
							<th data-priority="1">Unit Of Measure</th>
							<th data-priority="1">Price Quoted</th>
							<th data-priority="2">Note</th>
							<th data-priority="1">Options</th>
						</tr>
					</thead>
				</table>
			</div>
		</section>

		<div id="dialog-message" title="Add Item">
			<form action="" class="dialog" id='item'>
				<div class="dialog-form">
					<div class="oneTwo required-field">
						<label for='item_input'>Item ID </label>
						<input type="hidden" name="item" id='item_input' />
						<input type="text" name='item_id' id="item_id" class="validate[required]" />
					</div>

					<div class="oneTwo required-field">
						<label for='uom'>Unit of Mesure</label>
						<select name="uom" id='uom' class="validate[required]">
							<option value=''>-- Select UOM --</option>
						</select>
					</div>

					<div class="oneTwo required-field">
						<label for='price'>Price ($)</label>
						<input type="text" class="validate[required,custom[number]]" name="price" id='price' placeholder="You can override the price" />
					</div>

					<div class="oneTwo required-field">
						<label for='qty'>Qty</label>
						<input type="text" name="qty" id='qty' class="validate[required]" />
					</div>

					<div class="oneTwo dialog-note">
						<label for='note'>Note</label>
						<textarea rows="5" name='note' id='note' maxlength="255" class="validate[maxSize[255]]"></textarea>
						<input type="hidden" id="is_edit" value='0' />
					</div>
				</div>
			</form>
		</div>
	</div>
</main>
<!-- Right panel -->
<div class="sidebar-container">
	<aside id="sidebar-quicklinks" class="sidebar">
		<nav aria-label="Actions" class="sidebar-inner">
			<div class="sidebar-inner-nav">
				<div class="quick-links">
					<ol>
						<?php if ($quote['approve_status'] != 10) { ?>
							<li>
								<a href="/quote/approve/id/<?= $quote['quote_id'] ?>" title="" class='quick-link approve'>
									<span class='icon icon-approval'></span>
									Approve
								</a>
							</li>
						<?php } ?>
						<li>
							<a class='quick-link' href="<?= 'http://' . SITEURL . "/dompdf/print.php?url=" . 'http://' . SITEURL . "/quote/print/id/" . $quote['quote_id'] . "?company=" . substr($quote['quote_no'], 0, 3) . "&name=Centura_Quote_" . $quote['quote_id'] . '.pdf' ?>" title="print">
								<span class='icon icon-pdf'></span>
								Print Quote
							</a>
						</li>
						<?php if ($quote['approve_status'] == 10) { ?>
							<li>
								<a class='quick-link' href="/mail/quote/id/<?= $quote['quote_id'] ?>" title="mail">
									<span class='icon icon-mail'></span>
									Mail Quote
								</a>
							</li>
							<li><a href="/quote/approve/id/<?= $quote['quote_id'] ?>" title="" class='quick-link approve'>
									<span class='icon icon-approval'></span>
									Edit And Approve
								</a>
							</li>
						<?php } ?>
						<?php if ($quote['approve_status'] != -1) { ?>
							<li>
								<a href="/quote/disapprove/id/<?= $quote['quote_id'] ?>" title="" class='quick-link disapprove'>
									<svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
										<path d="M18.53 9L13 3.47C12.8595 3.32931 12.6688 3.25018 12.47 3.25H8C7.27065 3.25 6.57118 3.53973 6.05546 4.05546C5.53973 4.57118 5.25 5.27065 5.25 6V18C5.25 18.7293 5.53973 19.4288 6.05546 19.9445C6.57118 20.4603 7.27065 20.75 8 20.75H16C16.7293 20.75 17.4288 20.4603 17.9445 19.9445C18.4603 19.4288 18.75 18.7293 18.75 18V9.5C18.7421 9.3116 18.6636 9.13309 18.53 9ZM13.25 5.81L16.19 8.75H13.25V5.81ZM16 19.25H8C7.66848 19.25 7.35054 19.1183 7.11612 18.8839C6.8817 18.6495 6.75 18.3315 6.75 18V6C6.75 5.66848 6.8817 5.35054 7.11612 5.11612C7.35054 4.8817 7.66848 4.75 8 4.75H11.75V9.5C11.7526 9.69811 11.8324 9.88737 11.9725 10.0275C12.1126 10.1676 12.3019 10.2474 12.5 10.25H17.25V18C17.25 18.3315 17.1183 18.6495 16.8839 18.8839C16.6495 19.1183 16.3315 19.25 16 19.25Z" />
										<path d="M14.47 11.9101C14.312 11.7893 14.1134 11.7344 13.9158 11.7568C13.7183 11.7791 13.537 11.8771 13.41 12.0301L12 13.8001L10.59 12.0001C10.5243 11.9226 10.4441 11.8588 10.3537 11.8123C10.2634 11.7659 10.1648 11.7377 10.0636 11.7293C9.96242 11.721 9.86055 11.7326 9.76384 11.7636C9.66713 11.7946 9.57747 11.8444 9.49999 11.9101C9.42251 11.9757 9.35872 12.056 9.31227 12.1463C9.26581 12.2366 9.2376 12.3352 9.22925 12.4364C9.22089 12.5376 9.23255 12.6395 9.26356 12.7362C9.29457 12.8329 9.34433 12.9226 9.40999 13.0001L11 15.0001L9.40999 17.0001C9.28534 17.1565 9.22796 17.3561 9.25046 17.5549C9.27296 17.7537 9.37351 17.9354 9.52999 18.0601C9.68647 18.1847 9.88606 18.2421 10.0848 18.2196C10.2836 18.1971 10.4653 18.0965 10.59 17.9401L12 16.2001L13.41 18.0001C13.4818 18.0871 13.5719 18.1573 13.6738 18.2057C13.7758 18.2541 13.8871 18.2795 14 18.2801C14.1534 18.2928 14.3069 18.258 14.4398 18.1804C14.5728 18.1029 14.6786 17.9863 14.743 17.8466C14.8074 17.7068 14.8273 17.5506 14.7999 17.3992C14.7726 17.2478 14.6993 17.1084 14.59 17.0001L13 15.0001L14.63 13.0001C14.6922 12.9184 14.7375 12.8252 14.7632 12.7258C14.7889 12.6264 14.7944 12.5229 14.7795 12.4214C14.7646 12.3198 14.7295 12.2223 14.6764 12.1345C14.6232 12.0466 14.5531 11.9703 14.47 11.9101Z" />
									</svg>
									Disapprove
								</a>
							</li>
						<?php } ?>
						<?php if ($quote['approve_status'] != 10) { ?>
							<li>
								<a href="/quote/delete/id/<?= $quote['quote_id'] ?>" title="" class='quick-link delete_quote'>
									<span class='icon icon-trash'></span>
									Delete
								</a>
							</li>
						<?php } ?>
					</ol>
				</div>
			</div>
		</nav>
	</aside>
</div>

<script type="text/javascript">
	$("textarea").each(function() {
		this.setAttribute("style", "height:" + (this.scrollHeight) + "px;overflow-y:hidden;");
	}).on("input", function() {
		this.style.height = 0;
		this.style.height = (this.scrollHeight) + "px";
	});

	let itemTable = $("#items").DataTable({
		ajax: {
			url: "/quote/item/id/" + $('#quote_id').val(),
			dataSrc: ''
		},
		processing: true,
		columns: [{
				data: "product_id",
				render: function(data, type, row, meta) {
					return '<b class="item-name">' + data + '</b>' + '<br>' + row.item_desc;
				}
			},
			{
				data: "qty"
			},
			{
				data: "unit_price"
			},
			{
				data: "uom"
			},
			{
				data: "subtotal"
			},
			{
				data: "note"
			},
			{
				data: "product_id",
				render: function(data, type, row, meta) {
					//var oldData = getolddata($(this).closest('tr'));
					return '<div class="row-button">' +
						'<a title="Edit this item" class="edit" href="#">' +
						'<span class="button-wrap">' +
						'<span class="icon icon-edit"></span>' +
						'</span></a>' +
						'<a title="Delete this item" class="item_delete" href="/project/deleteitem/pro/' + row.project_id + '/item/' + data + '/uom/' + row.uom + '/price/' + row.unit_price + '/qty/' + row.qty + '"' +
						'index="' + data + '">' +
						'<span class="button-wrap">' +
						'<span class="icon icon-delete"></span>' +
						'</span></a></div>';
				}
			}
		],
		columnDefs: [{
				targets: [0, 1, 2, 3, 4],
				className: 'dt-body-center'
			},
			{
				targets: [0, 1, 2, 3, 4, 5, 6],
				className: 'dt-head-center'
			},
		],
		layout: {
			topStart: null,
			topEnd: null
		},
		order: {
			data: "added.date"
		},
		paging: false,
		scrollX: true,
		fixedColumns: {
			start: 1,
			end: 1
		}
	});


	function resetForm($form) {
		$form.find('input:text, input:password, input:file, select, textarea').val('');
		$form.find('input:radio, input:checkbox')
			.prop('checked', false)
			.prop('selected', false);
	}

	var current_edit_row = '';

	$(function() {

		let currentRow = '';

		$('#items tbody').on('click', 'tr', function() {
			currentRow = itemTable.row(this).data();
			//console.log(currentRow['product_id'], currentRow['note'], currentRow['qty']);
		});

		function getolddata(row) {
			let item_id = currentRow['product_id'];
			let note = currentRow['note'];
			let qty = currentRow['qty'];
			let unit_price = currentRow['unit_price'];
			let uom = currentRow['uom'];
			let data = {
				'old_item_id': item_id,
				'old_uom': uom,
				'old_price': unit_price,
				'old_qty': qty,
				'old_note': note
			};
			return data;
		}

		$("#dialog-message").dialog({
			autoOpen: false,
			modal: true,
			width: 800,
			minWidth: 800,
			open: function() { // fade in background
				$('.ui-widget-overlay').hide().fadeIn();
			},
			beforeClose: function() { //fade out background
				$('.ui-widget-overlay:first')
					.clone()
					.appendTo('body')
					.show()
					.fadeOut(400, function() {
						$(this).remove();
					});
			},
			buttons: [{
					id: "add-item-confirm-button",
					text: "Add",
					click: function() {
						if ($("#item").validationEngine('validate') == true) {
							if ($('#is_edit').val() == 1) {
								edititem($('#item_id').val(), $('#item_input').val(), $('#uom').val(), $('#price').val(), $('#qty').val(), $('#note').val());
							} else {
								additem();
							}
							$(this).dialog("close");
							resetForm($('#item'));
						}
					}
				},
				{
					id: "add-item-cancel-button",
					text: "Cancel",
					click: function() {
						$(this).dialog("close");
					}
				}
			]
		});

		$('#opener').on("click", function() {
			resetForm($('#item'));
			$('#is_edit').val(0);
			return false;
		});

		$(document).on("click", "a.edit", function() {
			$("#dialog-message").dialog("open");
			current_edit_row = $(this).closest('tr');
			set_edit(current_edit_row);
			return false;
		});

		function set_edit(row) {
			$("#dialog-message").dialog("option", "title", "Edit Item");
			$('#is_edit').val(1);

			let item_id = currentRow['product_id'];
			let note = currentRow['note'];
			let qty = currentRow['qty'];
			let unit_price = currentRow['unit_price'];
			let uom = currentRow['uom'];

			//$('#item #item_input').val(item_name);
			$('#item #item_id').val(item_id);
			$('#item #price').val(unit_price);
			$('#item #qty').val(qty);
			$('#item #note').val(note);

			getoumedit(item_id, uom, unit_price);
		}

		function edititem(item_id, item_desc, uom, price, qty, note) {
			var olddata = getolddata(current_edit_row);
			var data = {
				'item_id': item_id,
				'uom': uom,
				'price': price,
				'qty': qty,
				'note': note,
				'old_item_id': olddata['old_item_id'],
				'old_uom': olddata['old_uom'],
				'old_price': olddata['old_price'],
				'old_qty': olddata['old_qty'],
				'old_note': olddata['old_note']
			};
			$('.loading').show();
			$.ajax({
				url: '/project/edititem/pro/' + $('#project_id').val(),
				type: "post",
				data: data,
				success: function(data) {
					$('.loading').hide();
					itemTable.ajax.reload();
				}
			});
		}

		function additem() {
			$('.loading').show();
			$.ajax({
				url: '/project/additem/pro/' + $('#project_id').val(),
				type: "post",
				data: $("#item").serialize(),
				success: function(data) {
					$('.loading').hide();
					itemTable.ajax.reload();
				}
			});
		}

		function getoumedit(item_id, unit_number, price) {
			$('.loading').show();
			$.ajax({
				url: '/item/uom/id/' + $("#item_id ").val(),
				type: "get",
				success: function(data) {
					var uom = JSON.parse(data);
					var list = '';
					$.each(uom, function(i, item) {
						list = list + '<option value="' + item.uom + '">' + item.uom + '</option>';
					});
					$('#uom').html(list);
					$('#uom option[value=' + unit_number + ']').attr('selected', 'selected');
					$('#uniform-uom span').html(unit_number);
					$('#price').val(price);
					$('.loading').hide();
				}
			});

		}

		$(".dialog #item_id").autocomplete({
			source: '/item/index/',
			minLength: 2,
			focus: function(event, ui) {
				$("#item_input").val(ui.item.item_desc);
				return false;
			},
			select: function(event, ui) {
				$("#item_input").val(ui.item.item_desc);
				$("#item_id ").val(ui.item.item_id);
				getoum(ui.item.item_id);
				$('#uom').removeAttr('disabled');
				$('#uniform-uom').removeClass('disabled');
				return false;
			}
		}).data("ui-autocomplete")._renderItem = function(ul, item) {
			return $("<li></li>")
				.data("item.autocomplete", item)
				.append("<a><b>" + item.item_id + " - " + item.item_desc + "</b></a>")
				.appendTo(ul);
		};

		function getoum(item_id) {
			$('.loading').show();
			$.ajax({
				url: '/item/uom/id/' + $("#item_id ").val(),
				type: "get",
				success: function(data) {
					var uom = JSON.parse(data);
					var list = '';
					$.each(uom, function(i, item) {
						list = list + '<option value="' + item.uom + '">' + item.uom + '</option>';
					});
					$('#uom').html(list);
					$('#uom option').eq(0).attr("selected", "selected");
					$('#uniform-uom span').html(uom[0].uom);
					getprice();
					$('.loading').hide();
				}
			});

		}

		function getprice() {
			$('.loading').show();
			$.ajax({
				url: '/item/price/id/' + $("#item_id ").val() + '/uom/' + $("#uom ").val(),
				type: "get",
				success: function(data) {
					var price = JSON.parse(data);
					$('#price').val(price.price);
					$('.loading').hide();
				}
			});

		}

		function getcustomerbyid(id) {
			$('.loading').show();
			$.ajax({
				url: '/customer/fetchbyid/id/' + id,
				type: "get",
				success: function(data) {
					var result = JSON.parse(data);
					if (result != null) {
						$('#quote').val(result.name);
						$('#customer_id').val(id);
						$('#address').val(result.phys_address1 + ' ' + result.phys_address2 + ' ' + result.phys_city + ' ' + result.mail_state + ' ' + result.phys_country + ' ' + result.mail_postal_code);
						$('#tel').val(result.tel);
						$('#contact').val(result.first_name + ' ' + result.last_name);
						$('#customer_email').val(result.email);
						$('#sale_rep').val(result.sale_rep);

					} else {
						alert('Can\'t find customer');
						$('#customer_info input').val('');
					}
					$('.loading').hide();
				}
			});
		}

		$('#add_new_mode').on("click", function() {
			$('#quote, #address, #tel, #customer_id').removeAttr('readonly');
		});

		$("#uom,#uniform-uom").on("change", function() {
			getprice();
			return false;
		});

		$(document).on('click', ".item_delete", function(e) {
			e.preventDefault();
			if (confirm("Are you sure you want to delete this item?") == true) {
				$('.loading').show();
				$.ajax({
					url: $(this).attr('href'),
					type: "get",
					success: function(data) {
						itemTable.ajax.reload();
						$('.loading').hide();
					}
				});
			}
		});

		$("#customer_email").autocomplete({
			source: "/customer/email/",
			minLength: 2,
			select: function(event, ul) {
				getcustomerbyid(ul.item.customer_id);
			}
		}).data("ui-autocomplete")._renderItem = function(ul, item) {
			return $("<li></li>")
				.data("item.autocomplete", item)
				.append("<a>" + item.email + "<br>" + item.first_name + ' ' + item.last_name + "</a>")
				.appendTo(ul);
		};

		$("#quote").autocomplete({
			source: "/customer/quote/",
			minLength: 2,
			select: function(event, ul) {
				getcustomerbyid(ul.item.customer_id);
			}
		}).data("ui-autocomplete")._renderItem = function(ul, item) {
			return $("<li></li>")
				.data("item.autocomplete", item)
				.append("<a>Company: " + item.name + "<br>" + item.fullname + ' ' + item.city + ' ' + item.tel + "</a>")
				.appendTo(ul);
		};
		$("#contact").autocomplete({
			source: "/customer/name/",
			minLength: 2,
			select: function(event, ul) {
				getcustomerbyid(ul.item.customer_id);
			},

		}).data("ui-autocomplete")._renderItem = function(ul, item) {
			return $("<li></li>")
				.data("item.autocomplete", item)
				.append("<a>Company: " + item.name + "<br>" + item.fullname + ' ' + item.city + ' ' + item.tel + "</a>")
				.appendTo(ul);
		};

		$('a.save_quote').on("click", function(e) {
			e.preventDefault();
			if ($("#quote_content").validationEngine('validate') == true) {
				$('.loading').show();
				$('#quote_content').submit();
			}
		});

		$('a.delete_quote').on("click", function(e) {
			if (confirm("Confirm delete This Quote?") == true) {
				$.ajax({
					url: $(this).attr('href'),
					type: "post",
					success: function(data) {
						window.location = "/index/approval";
					}
				});
			} else {
				e.preventDefault();
			}
		});

		$('a.approve').on("click", function(e) {
			e.preventDefault();
			if ($("#quote_content").validationEngine('validate') == true) {
				if (confirm("Are you sure you want to approve this quote?") == true) {
					$('.loading').show();
					$.ajax({
						url: $(this).attr('href'),
						type: "post",
						data: $('#quote_content').serialize(),
						success: function(data) {
							window.location.reload();
						}
					});
					$('.loading').hide();
				}
			} else {
				return false;
			}

		});

		$('a.disapprove').on("click", function(e) {
			e.preventDefault();
			if (confirm("Are you sure you want to disapprove this quote?") == true) {
				$('.loading').show();
				$.ajax({
					url: $(this).attr('href'),
					type: "get",
					success: function(data) {
						window.location.reload();
					}
				});
				$('.loading').hide();
			}
		});
	});
</script>
<?php $session =  Zend_Registry::get('session');
//$project = $this->project; 
?>
<!-- Title area -->
<main id="content" class="main-content">
  <div class="main-page-content">
    <header class="main-page-content-header">
      <div class="options-menu">
        <button class="quick-link options-button" id="options-button" type="button">
          <span class='icon icon-menu'></span>
          Options
        </button>

        <!-- Right panel -->
        <div class="sidebar-container" id="options-menu-items">
          <a href="/project/" target="_blank" class='button quick-link add-project' title="Add new project">
            <span class='icon icon-add'></span>
            Add Project</a>
        </div>
      </div>

      <h1>Add Project</h1>
    </header>
    <!-- Main content wrapper -->
    <section aria-labelledby="project-information" id="section1" data-nav="Project Information" class="active">
      <form action="/project/save" method="post" class="form" id='project_content'>
        <div class="widget-table">
          <div class="widget-header">
            <div class="widget-title">
              <h2>Project Information</h2>
            </div>
          </div>

          <div class="line"></div>
          <div class="widget-section">
            <div class="formRow">
              <input type="hidden" id='project_id_ext' name='project_id_ext' />
              <input type="hidden" name='create_date' value='' />

              <div class="oneTwo required-field">
                <label for="project_name">Project Name</label>
                <input type="text" id='project_name' name='project_name' class="validate[required]" />
              </div>

              <div class="oneTwo required-field">
                <label for='project_address'>Project Location</label>
                <input id='project_address' name='project_address' type="text" class="validate[required] tipN" original-title="Example: 53 Apex Road, Toronto, Ontario, M6A 2V6" />
              </div>

              <div class="oneTwo">
                <label for="location_id">Centura Location</label>
                <select name="location_id" id="location_id">
                  <?php foreach ($this->locations as $l) { ?>
                    <option value="<?= $l['location_id'] ?>" <?php if ($l['location_id'] == DEFAULT_COMPNAY_ID) echo 'selected' ?>><?= $l['branch_description'] ?></option>
                  <?php } ?>
                </select>
              </div>

              <div class="oneTwo required-field">
                <label for="status">Project Stage</label>
                <select name="status" id='status' class="validate[required]">
                  <option value="">-- Select stage --</option>
                  <?php foreach ($this->status as $s) { ?>
                    <option value="<?= $s['status_id'] ?>"><?= $s['status_desc'] ?></option>
                  <?php } ?>
                </select>
              </div>

              <div class="oneTwo required-field">
                <label for="market_segment_id">Project Category</label>
                <select name="market_segment_id" id='market_segment_id' class="validate[required]">
                  <option value="">-- Choose category --</option>
                  <?php foreach ($this->seg as $s) { ?>
                    <option value="<?= $s['market_segment_id'] ?>"><?= $s['market_segment_desc'] ?></option>
                  <?php } ?>
                </select>
              </div>

              <div class="oneTwo">
                <label for="owner_id">Worksheet Owner</label>
                <input type="text" id="owner_id" name="owner_id" value='<?= $session->user['id'] ?>' readonly />
              </div>

              <div class="oneTwo required-field">
                <label for="reed">REED ID</label>
                <input type="text" name='reed' original-title="REED Format" id='reed' class="validate[required] tipN" />
              </div>

              <div class="oneTwo">
                <label for="due_date">Tender Due Date</label>
                <input type="text" id="due_date" name='due_date' class="datepicker" />
              </div>

              <div class="oneTwo">
                <label for="require_date">Required Date</label>
                <input type="text" id="require_date" name='require_date' placeholder="Required date" class="datepicker" />
              </div>

              <?php if ($session->user['approve_id'] != null) { ?>
                <div class="oneTwo">
                  <label for="shared_id">Share Worksheet</label>
                  <input type="text" id="shared_id" name="shared_id" placeholder="Share this project with other salesrep" />
                </div>
              <?php } else { ?>
                <input type="hidden" id="shared_id" name="shared_id" />
              <?php } ?>
            </div>
          </div>

          <div class="line"></div>

          <div class="widget-section">
            <div class="formRow">
              <div class="oneTwo required-field">
                <label for="architect_name">Project Architect/Owner</label>
                <input type='text' name="architect_name" id='architect_name' class="validate[required] tipN" original-title="You can change the architect / specifier location even if they exist in other branchs" />
                <input type="hidden" name='architect_id' id='architect_id' />
              </div>

              <div class="oneTwo">
                <label for="architect_location">Architect Location</label>
                <select id="architect_location" name="architect_location">
                  <?php foreach ($this->locations as $l) { ?>
                    <option value="<?= $l['location_id'] ?>" <?php if ($l['location_id'] == DEFAULT_COMPNAY_ID) echo 'selected' ?>><?= $l['branch_description'] ?></option>
                  <?php } ?>
                </select>
              </div>

              <div class="oneTwo required-field">
                <label for="architect_rep_id">Architect Rep.</label>
                <select id='architect_rep_id' name='architect_rep_id' class="validate[required]">
									<?php if ($session->user['approve_id'] != null) { ?>
										<?php foreach ($this->arch as $a) { ?>
											<option value="<?= $a['id'] ?>" <?php if ($a['id'] == $session->user['id']) echo 'selected'; ?>><?= $a['name'] . ' - ' . $a['default_company'] ?></option>
										<?php } ?>
									<?php } else { ?>
										<?php foreach ($this->arch as $a) { ?>
											<?php if ($a['id'] == $quote['arch']) { ?>
												<option value="<?= $a['id'] ?>" selected><?= $a['name'] . ' - ' . $a['default_company'] ?></option>
											<?php } ?>
										<?php } ?>
									<?php } ?>
								</select>
              </div>
            </div>
          </div>

          <div class="line"></div>

          <div class="widget-section">
            <div class="formRow">
              <div class="oneTwo required-field">
                <label for="specifier_name">Specifier</label>
                <input type='text' id='specifier_name' name="specifier_name" class="validate[required] tipN" />
                <input type="hidden" id='specifier_id' name="specifier_id" />
              </div>

              <div class="oneTwo">
                <label for="specifier_location">Specifier Location</label>
                <select id="specifier_location" name="specifier_location">
                  <?php foreach ($this->locations as $l) { ?>
                    <option value="<?= $l['location_id'] ?>" <?php if ($l['location_id'] == DEFAULT_COMPNAY_ID) echo 'selected' ?>><?= $l['branch_description'] ?></option>
                  <?php } ?>
                </select>
              </div>
            </div>
          </div>

          <div class="line"></div>

          <div class="widget-section">
            <div class="formRow">
              <div class="oneTwo">
                <label for="general_contractor_name">General Contractor</label>
                <input type="text" id="general_contractor_name" name="general_contractor_name" class='tipN' placeholder="Add general contractor" original-title="Type Company Name" />
                <input type="hidden" id="general_contractor_id" name="general_contractor_id" />
              </div>

              <div class="oneTwo">
                <label for="awarded_contractor_name">Awarded Contractor</label>
                <input id="awarded_contractor_name" name="awarded_contractor_name" type="text" class='tipN' placeholder="Add awarded contractor" original-title="Type Company Name" />
                <input id="awarded_contractor_id" name="awarded_contractor_id" type="hidden" />
              </div>
            </div>
          </div>

          <div class="line"></div>

          <div class="widget-footer">
            <div class="widget-footer-button">
              <button disabled id="save_pro" type="button" title="Create project" class="button action create-project-button small">
                <span class="button-wrap">
                  Create Project
                </span>
              </button>
            </div>
          </div>
        </div>
      </form>
    </section>
  </div>
</main>

<script>
  $(function() {
    if ($("#shared_id").length) {
      $('#shared_id').autocomplete({
        source: '/user/id',
        minLength: 1,
        select: function(event, ui) {
          $('#shared_id').val(ui.item.id);
          return false;
        }
      }).data("ui-autocomplete")._renderItem = function(ul, item) {
        return $("<li></li>")
          .data("item.autocomplete", item)
          .append("<a>" + item.id + "</br>" + item.name + "</a>")
          .appendTo(ul);
      }
    };

    function getContractor(id, targetPrefix) {
      $.ajax({
        url: '/customer/fetchbyid/id/' + id,
        type: "get",
        success: function(data) {
          var result = data ? JSON.parse(data) : null;
          if (result) {
            $('#' + targetPrefix + '_id').val(result.customer_id);
            $('#' + targetPrefix + '_name').val(result.customer_name);
          }
        }
      });
    }

    function getSpecifierOrArchitect(id, type) {
      $.ajax({
        url: '/specifier/fetchspecbyid/id/' + id,
        type: "get",
        success: function(data) {
          var result = data ? JSON.parse(data) : null;
          if (result) {
            $('#' + type + '_name').val(result.specifier_name);
            $('#' + type + '_id').val(result.specifier_id);
            $('#' + type + '_location').val(result.location_id);
          }
        }
      });
    }

    function setupAutocomplete(selector, sourceUrl, selectCallback, isContractor = false) {
      $(selector).autocomplete({
        source: sourceUrl,
        minLength: 2,
        select: function(event, ui) {
          selectCallback(ui.item);
        }
      }).data("ui-autocomplete")._renderItem = function(ul, item) {
        return $("<li>")
          .data("item.autocomplete", item)
          .append("<a>" +
            (isContractor ? (item.customer_id + " - " + item.company_id + "<br>" + item.customer_name) :
              (item.specifier_name + " - " + item.location_id + "<br>" + item.branch_description)) +
            "</a>")
          .appendTo(ul);
      };
    }

    setupAutocomplete("#architect_name", "/specifier/fetchspecbyname/", function(item) {
      getSpecifierOrArchitect(item.specifier_id, 'architect');
    });

    setupAutocomplete("#specifier_name", "/specifier/fetchspecbyname/", function(item) {
      getSpecifierOrArchitect(item.specifier_id, 'specifier');
    });

    setupAutocomplete("#general_contractor_name", "/customer/quote/", function(item) {
      getContractor(item.customer_id, 'general_contractor');
    }, true);

    setupAutocomplete("#awarded_contractor_name", "/customer/quote/", function(item) {
      getContractor(item.customer_id, 'awarded_contractor');
    }, true);

    $('#architect_location, #specifier_location').on('change', function() {
      $('#' + $(this).attr('id').replace('_location', '_id')).val('');
    });

    let unsave = false;

    $('#project_content').on("change", function() {
      $('#save_pro').prop("disabled", false);
      unsave = true;
    });

    $('#save_pro').on("click", function(e) {
      e.preventDefault();
      if ($("#project_content").validationEngine('validate') == true) {
        $('#project_content').trigger("submit");
      }

    });
  })
</script>